# Аудит слабых мест cpp_ast_v3

## Статус после рефакторинга (10.10.2025)

### ✅ Выполнено
- **Размеры файлов**: DeclarationParser 1173→22, Lexer 674→324
- **Модульность**: 7 parser модулей, 3 lexer helpers
- **Тесты**: 100% roundtrip (481/481)
- **Документация**: удалено 8 устаревших отчётов

## Приоритет 1: Критичные проблемы

### 1.1 Большие файлы (требуют декомпозиции)
- **statements.rb** (547 строк) - содержит 20+ классов
  - Разделить: control_flow_nodes, declaration_nodes, basic_nodes
  - Трудозатраты: 1 час
  - Риск: низкий

- **expression_parser.rb** (540 строк) - смешанная логика
  - Разделить: binary_expr, literal, cast, unary
  - Трудозатраты: 2 часа
  - Риск: средний

- **function_parser.rb** (512 строк) - сложная логика
  - Уже выделен из declaration_parser
  - Можно разделить на constructor/destructor/operator/regular
  - Трудозатраты: 2 часа
  - Риск: низкий

### 1.2 Отсутствие trivia в токенах (эталонное требование)
**Проблема**: Trivia хранится как строки в узлах, а не в Token объектах

**Текущая архитектура**:
```ruby
token.leading_trivia = "  // comment\n"  # строка
token.trailing_trivia = " "
```

**Эталон (cpp_parser_arch.md)**:
```ruby
token.leading_trivia = [
  Trivia.new(kind: :space, text: "  ", byte_range: 0..2),
  Trivia.new(kind: :comment, text: "// comment", byte_range: 2..12),
  Trivia.new(kind: :newline, text: "\n", byte_range: 12..13)
]
```

**Последствия**:
- ❌ Нет байтовых диапазонов для trivia
- ❌ Нельзя точно сопоставить trivia с исходником
- ❌ Сложное редактирование (нет инкрементальных обновлений)
- ✅ Roundtrip работает (100%)

**Решение**: Фаза 2 из TRIVIA_IN_TOKENS_ROADMAP.md
- Трудозатраты: 6-8 часов
- Риск: высокий (требует обновления всех 481 теста)
- Приоритет: решение пользователя (работает и так)

### 1.3 Отсутствие Green/Red дерева
**Проблема**: Используется mutable AST, а не immutable Green + mutable Red

**Текущая архитектура**: Прямая модификация узлов
**Эталон**: Green (immutable, shared) + Red (mutable, с родителями)

**Последствия**:
- ❌ Нет переиспользования подузлов
- ❌ Высокое потребление памяти на больших файлах
- ✅ Проще реализация
- ✅ Работает для средних файлов (< 10K строк)

**Решение**: Архитектурное изменение
- Трудозатраты: 20+ часов
- Риск: очень высокий
- Приоритет: низкий (работает для текущих задач)

## Приоритет 2: Покрытие C++ конструкций

### 2.1 Отсутствующие/неполные конструкции

**Lambdas**:
- ✅ Базовая поддержка
- ⚠️ Нет capture по умолчанию `[=]`, `[&]`
- ⚠️ Нет mutable lambda
- ⚠️ Нет template lambda (C++20)
- Трудозатраты: 3 часа

**Templates**:
- ✅ Базовая поддержка
- ❌ Нет variadic templates детально
- ❌ Нет SFINAE
- ❌ Нет concepts (C++20)
- ❌ Нет requires clauses
- Трудозатраты: 8-10 часов

**Structured bindings (C++17)**:
- ❌ `auto [a, b] = tuple;` не поддерживается
- Трудозатраты: 2 часа

**Raw strings**:
- ✅ Базовая поддержка R"(...)"
- ⚠️ Не тестировано на сложных delimiters
- Трудозатраты: 1 час (тесты)

**Препроцессор**:
- ✅ Директивы парсятся как trivia
- ⚠️ Нет `##` (token pasting)
- ⚠️ Нет `\`-continuation детально
- ⚠️ Trigraphs/digraphs не тестировались
- Трудозатраты: 4 часа

**Атрибуты (C++11)**:
- ✅ `[[nodiscard]]` поддерживается
- ⚠️ Не протестировано на вложенных `[[ [[ ]] ]]`
- Трудозатраты: 1 час

## Приоритет 3: Качество кода

### 3.1 DRY нарушения

**Дублирование в parsers**:
```ruby
# В нескольких парсерах:
while current_token.kind == :colon_colon
  advance_raw
  current_leading_trivia
  ...
end
```
**Решение**: Вынести в `parse_qualified_name` в base_parser
- Трудозатраты: 2 часа

**Дублирование в nodes**:
- Много повторяющихся `to_source` методов
- Решение: Общий builder или макросы
- Трудозатраты: 3 часа

### 3.2 Cyclomatic complexity

**Высокая сложность**:
- `function_parser.rb`: методы с 5+ уровнями вложенности
- `expression_parser.rb#parse_primary_expression`: 40+ строк case
- `control_flow_parser.rb#parse_for_statement`: сложная логика

**Решение**: Дополнительная декомпозиция
- Трудозатраты: 4 часа

### 3.3 Магические числа/строки

**Найдено**: Минимум
- `" "` для разделителей (допустимо)
- Нет магических чисел

**Оценка**: ✅ Хорошо

### 3.4 Отсутствие комментариев

**Проблемные методы** (сложные без комментариев):
- `looks_like_function_declaration?` - эвристики не объяснены
- `check_operator_overload_pattern` - сложная логика lookahead
- `parse_function_modifiers_postfix` - неясна логика initializer list

**Решение**: Добавить комментарии
- Трудозатраты: 2 часа

## Приоритет 4: Тестирование

### 4.1 Edge cases не покрыты

**Unicode**:
- ❌ Нет тестов на UTF-8 в идентификаторах (C++11)
- ❌ Нет тестов на emoji в комментариях
- ❌ Нет тестов на BOM (UTF-8, UTF-16)
- Трудозатраты: 2 часа

**Line endings**:
- ❌ Нет тестов `\r\n` (Windows)
- ❌ Нет тестов `\r` (старый Mac)
- ⚠️ Только `\n` (Unix) тестируется
- Трудозатраты: 1 час

**Пустые файлы**:
- ❌ Нет теста на пустой файл
- ❌ Нет теста на файл только с комментариями
- ❌ Нет теста на файл только с `#include`
- Трудозатраты: 30 минут

**Глубокая вложенность**:
- ❌ Нет теста на шаблоны 10+ уровней
- ❌ Нет теста на вложенные блоки 20+ уровней
- Трудозатраты: 1 час

**Большие файлы**:
- ❌ Нет теста на файл > 10K строк
- ❌ Нет теста на файл > 1MB
- Трудозатраты: 2 часа (+ профилирование)

### 4.2 Недостаточное покрытие

**Текущее покрытие**: ~46 тестов
**Строк кода**: ~4000

**Пропущенные области**:
- Error recovery (парсер падает на ошибках)
- Partial parsing (нет инкрементального парсинга)
- Concurrent parsing (нет thread-safety)

## Приоритет 5: Производительность

### 5.1 Узкие места (предполагаемые)

**Lexer**:
- String concatenation в циклах (`lexeme << char`)
- Много вызовов `current_char` и `peek`
- **Решение**: Профилирование на больших файлах
- Трудозатраты: 4 часа

**Parser**:
- Множество lookahead операций (`looks_like_*`)
- Сохранение/восстановление позиции
- **Решение**: Кэширование lookahead результатов
- Трудозатраты: 6 часов

**Memory**:
- Хранение trivia как строк (дублирование)
- Нет String interning для токенов
- **Решение**: Rope/interned strings
- Трудозатраты: 8 часов

### 5.2 Нет профилирования

**Отсутствует**:
- Benchmark на реальных проектах (Linux kernel, LLVM)
- Memory profiling
- Bottleneck analysis

**Решение**: scripts/profile_parser.rb уже есть
- Запустить на gtk_gl_sample.cpp
- Запустить на больших файлах
- Трудозатраты: 2 часа

## Приоритет 6: Документация

### 6.1 Отсутствует API документация
- Нет YARD/RDoc комментариев
- Нет примеров использования
- Нет guide для расширения парсера
- Трудозатраты: 6 часов

### 6.2 Архитектурная документация неполная
- ✅ cpp_parser_arch.md описывает эталон
- ✅ CST_ARCHITECTURE_SUMMARY.md описывает статус
- ⚠️ Нет диаграмм классов
- ⚠️ Нет sequence diagrams для парсинга
- Трудозатраты: 4 часа

## Итоговые рекомендации

### Быстрые победы (1-2 дня)
1. ✅ **Разбить большие файлы** - декомпозиция завершена частично
2. **Edge cases тесты** - Unicode, line endings, пустые файлы (4 часа)
3. **DRY рефакторинг** - parse_qualified_name и др. (2 часа)
4. **Комментарии к сложным методам** (2 часа)
5. **Профилирование** на больших файлах (2 часа)

### Средний приоритет (1 неделя)
1. **Покрытие C++17/20** - structured bindings, concepts (10 часов)
2. **Lambda расширения** - capture modes, mutable (3 часа)
3. **Препроцессор улучшения** - ##, \-continuation (4 часа)
4. **API документация** - YARD comments (6 часов)

### Долгосрочно (1+ месяц)
1. **Trivia в токенах** - Фаза 2 из roadmap (8 часов)
2. **Green/Red дерево** - архитектурное изменение (20+ часов)
3. **Производительность** - optimization pass (14 часов)
4. **Error recovery** - graceful degradation (10 часов)

## Метрики качества

### Текущие
- Roundtrip: ✅ 100% (481/481)
- Архитектура: ⚠️ 7/10 (нет trivia в токенах, нет Green/Red)
- Покрытие C++: ⚠️ 6/10 (базовые конструкции работают)
- Производительность: ❓ Не измерено
- Документация: ⚠️ 5/10 (есть архитектурные доки)

### Цели
- Roundtrip: 100% (сохранить)
- Архитектура: 9/10 (trivia в токенах)
- Покрытие C++: 8/10 (C++17/20 базовые конструкции)
- Производительность: < 1s на 10K строк
- Документация: 8/10 (API + примеры)

## Заключение

Проект находится в **хорошем состоянии** для lossless C++ парсера:
- ✅ 100% roundtrip достигнут
- ✅ Чистая архитектура после рефакторинга
- ✅ Модульная структура

**Главные риски**:
- Отсутствие trivia в токенах (архитектурное требование)
- Ограниченное покрытие C++17/20
- Не измерена производительность на больших файлах

**Рекомендуемый путь**:
1. Завершить edge cases тесты (4 часа)
2. Профилирование (2 часа)
3. DRY рефакторинг (2 часа)
4. Решить: внедрять ли Фазу 2 (trivia в токенах)

